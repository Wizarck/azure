{
    "$schema": "http://schema.management.azure.com/schemas/2014-04-01-preview/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "complianceProfile": {
            "type": "string",
            "metadata": {
                "description": "PCI or no-PCI"
            },
            "defaultValue": "no-pci",
            "allowedValues": [
				"no-pci",
                "pci"
            ]
        },
        "environment": {
            "type": "string",
            "metadata": {
                "description": "Define environment to deploy in"
            },
            "defaultValue": "development",
            "allowedValues": [
				"production",
                "preproduction",
                "development"
            ]
        },
        "virtualNetworkName": {
            "type": "string",
            "metadata": {
                "description": "Name of the existing vNet"
            },
            "defaultValue": "commp-vnet1"
        },
        "subnetName": {
            "type": "string",
            "metadata": {
                "description": "Name of the existing Subnet that will contain the App Service Environment"
            },
            "defaultValue": "commptew1"
        },




        "aseName": {
            "type": "string",
            "metadata": {
                "description": "Name of the App Service Environment"
            },
            "defaultValue": "asenamewizarck"
        },
        "internalLoadBalancingMode": {
            "type": "int",
            "defaultValue": 3,
            "allowedValues": [0,1,2,3],
            "metadata": {
                "description": "0 = public VIP only, 1 = only ports 80/443 are mapped to ILB VIP, 2 = only FTP ports are mapped to ILB VIP, 3 = both ports 80/443 and FTP ports are mapped to an ILB VIP."
            }
        },
        "dnsSuffix": {
            "type": "string",
            "metadata": {
                "description": "Used *only* when deploying an ILB enabled ASE.  Set this to the root domain associated with the ASE.  For example: contoso.com"
            },
            "defaultValue": "onmicrosoft.com"
        },



        "certificateName": {
            "type": "string",
            "metadata": {
                "description": "Name of the certificate.  This can be any name you want to use to identify the certificate."
            },
            "defaultValue": "certificateName"
        },
        "certificatePassword": {
            "type": "string",
            "metadata": {
                "description": "The password for the pfx filed contained in pfxBlobString."
            },
            "defaultValue": "PassWord01!"
        },




        "sqlServerName": {
            "type": "string",
            "metadata": {
                "description": "Name for the server of the SQL DB"
            },
            "defaultValue": "sqlservertestwizarck"
        },
        "sqlDatabaseName": {
            "type": "string",
            "metadata": {
                "description": "Name for the SQL Database"
            },
            "defaultValue": "sqldbnamewizarck"
        },
        "sqlAdminLogin": {
            "type": "string",
            "metadata": {
                "description": "Login for the SQL Admin User"
            },
            "defaultValue": "systemAdmin"
        },
        "sqlAdminPassword": {
            "type": "securestring",
            "metadata": {
                "description": "Password for the SQL Admin User"
            },
            "defaultValue": "PassWord01!"
        }





   
    },
    "variables": {     
        "vnetRef": "[resourceId(resourceGroup().name, 'Microsoft.Network/virtualNetworks', parameters('virtualNetworkName'))]",
        "subnetRef": "[resourceId(resourceGroup().name, 'Microsoft.Network/virtualNetworks/subnets', parameters('virtualNetworkName'), parameters('subnetName'))]",
        "certificateThumbprint": "AF3143EB61D43F6727842115BB7F17BBCECAECAE",
        "pfxBlobString": "MIIKcAIBAz...snip...snip...pkCAgfQ"
    },
    "resources": [
        {
            "apiVersion": "2015-05-01-preview",
            "type": "Microsoft.Sql/servers",
            "location": "[resourceGroup().location]",
            "tags": {
                "complianceProfile": "[parameters('complianceProfile')]",
                "environment": "[parameters('environment')]",
                "tier": "communications"
            },
            "name": "[parameters('sqlServerName')]",
            "properties": {
                "administratorLogin": "[parameters('sqlAdminLogin')]",
                "administratorLoginPassword": "[parameters('sqlAdminPassword')]",
                "version": "12.0"
            },
            "resources": [
                {
                    "apiVersion": "2014-04-01-preview",
                    "dependsOn": [
                        "[concat('Microsoft.Sql/servers/', parameters('sqlServerName'))]"
                    ],
                    "location": "[resourceGroup().location]",
                    "tags": {
                        "complianceProfile": "[parameters('complianceProfile')]",
                        "environment": "[parameters('environment')]",
                        "tier": "communications"
                    },
                    "name": "[parameters('sqlDatabaseName')]",
                    "properties": {
                        "collation": "SQL_Latin1_General_CP1_CI_AS",
                        "edition": "Basic",
                        "maxSizeBytes": "1073741824",
                        "sampleName": null
                    },
                    "type": "databases"
                },
                {
                    "apiVersion": "2014-04-01-preview",
                    "type": "firewallrules",
                    "dependsOn": [
                        "[concat('Microsoft.Sql/servers/', parameters('sqlServerName'))]"
                    ],
                    "location": "[resourceGroup().location]",
                    "name": "AllowAllWindowsAzureIps",
                    "properties": {
                        "endIpAddress": "0.0.0.0",
                        "startIpAddress": "0.0.0.0"
                    }                    
                }
            ]            
        },

       







        {
            "apiVersion": "2015-08-01",
            "type": "Microsoft.Web/certificates",
            "name": "[parameters('certificateName')]",
            "location": "[resourceGroup().location]",
            "properties": {
                "pfxBlob": "[variables('pfxBlobString')]",
                "password": "[parameters('certificatePassword')]",
                "hostingEnvironmentProfile": {
                     "id": "[resourceId('Microsoft.Web/hostingEnvironments',parameters('aseName'))]"
                }
            }
        },
        {
            "apiVersion": "2015-08-01",
            "type": "Microsoft.Web/hostingEnvironments",
            "name": "[parameters('aseName')]",
            "kind": "ASEV2",
            "location": "[resourceGroup().location]",
            "properties": {
                "name": "[parameters('aseName')]",
                "location": "[resourceGroup().location]",
                "ipSslAddressCount": 0,
                "internalLoadBalancingMode": "[parameters('internalLoadBalancingMode')]",
                "dnsSuffix" : "[parameters('dnsSuffix')]",
                "virtualNetwork": {
                    "Id": "[variables('vnetRef')]",
                    "Subnet": {
                        "Id": "[variables('subnetRef')]"
                    }
                },
                "clusterSettings": [
                      {
                            "name": "DefaultSslCertificateThumbprint",
                            "value": "[variables('certificateThumbprint')]"
                      }
                ]
            },
            "dependsOn": [
                "[concat('Microsoft.Web/certificates/',parameters('certificateName'))]"
            ]
        }     
    ]
}