{
    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {        
        "complianceProfile": {
            "type": "string",
            "allowedValues": [
				"no-pci",
                "pci"
            ],
            "defaultValue": "no-pci",
            "metadata": {
                "description": "PCI or no-PCI"
            }
        },
        "environment": {
            "type": "string",
            "allowedValues": [
				"production",
                "preproduction",
                "development"
            ],
            "defaultValue": "development",
            "metadata": {
                "description": "Define environment to deploy in"
            }
        },
        "virtualNetworkResourceGroup": {
            "type": "string",
            "metadata": {
                "description": "Resource Group of SQL Server"
            }
        },
        "AppName": {
            "type": "string",
            "defaultValue": "myappname123",
            "metadata": {
                "description": "Name for the Application"
            } 
        },
        "hostingEnvironment": {
            "type": "string",
            "defaultValue": "systemAdmin",
            "metadata": {
                "description": "Name of the Application Service Environment (ASE)"
            } 
        },
        "serverFarmID": {
            "type": "string",
            "defaultValue": "/subscriptions/7181402d-a481-459e-8f31-8a8e5cbe5702/resourceGroups/RG-PRUEBA1/providers/Microsoft.Web/serverFarms/ASEsimulator",
            "metadata": {
                "description": "ID of ServerFarm from Application Service Environment (ASE)"
            } 
        },
        "SQLServerName": {
            "type": "string",
            "defaultValue": "commpsqtew",
            "metadata": {
                "description": "Name for the SQL Server"
            }            
        },
        "SQLAdminLoginPassword": {
            "type": "securestring",
            "defaultValue": "PassWord01!",
            "metadata": {
                "description": "Password for the SQL Server Admin User"
            }            
        },
        "SQLDataBaseName": {
            "type": "string",
            "defaultValue": "sqldbnamesysadmin2",
            "metadata": {
                "description": "Name for the SQL Database"
            }            
        },        
        "AppInsightName": {
            "type": "string",
            "defaultValue": "commpistew1",
            "metadata": {
                "description": "Name for the Application Insight"
            }            
        }

    }, 
    "variables": {
        "SQLServerURL": "[concat(parameters('SQLServerName'), '.database.windows.net')]"  
    },
    "resources": [  
        {
            "apiVersion": "2017-05-10",
            "name": "VirtualNetworkExternalDeployment",
            "type": "Microsoft.Resources/deployments",
            "resourceGroup": "[parameters('VirtualNetworkResourceGroup')]",
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[concat(parameters('SQLServerName'),'/',parameters('SQLDataBaseName'))]",
                            "type": "Microsoft.Sql/servers/databases",
                            "apiVersion": "2014-04-01",
                            "location": "[resourceGroup().location]",               
                            "tags": {
                                "complianceProfile": "[parameters('complianceProfile')]",
                                "environment": "[parameters('environment')]",
                                "tier": "data"
                            },           
                            "properties": {
                                "collation": "SQL_Latin1_General_CP1_CI_AS",
                                "createMode": "default",
                                "edition": "Basic",
                                "maxSizeBytes": "1073741824",
                                "sampleName": null
                            }
                        }
                    ]
                },
                "parameters": {}
            }
        },
        {            
            "type": "microsoft.insights/components",
            "name": "[parameters('AppInsightName')]",
            "apiVersion": "2015-05-01",            
            "location": "[resourceGroup().location]",
            "kind": "other",
            "tags": {
                "complianceProfile": "[parameters('complianceProfile')]",
                "environment": "[parameters('environment')]",
                "tier": "monitoring",
                "[concat('hidden-link:', resourceGroup().id, '/providers/Microsoft.Web/sites/', parameters('AppName'))]": "Resource"
            },            
            "properties": {
                "mode": "incremental",
                "ApplicationId": "[parameters('AppInsightName')]",
                "Application_Type": "other",
                "Flow_Type": "Redfield"
            }
        },  
        { 
            "name": "[parameters('AppName')]",
            "type": "Microsoft.Web/sites",
            "apiVersion": "2016-03-01",
            "location": "[resourceGroup().location]",
            "tags": {
                "complianceProfile": "[parameters('complianceProfile')]",
                "environment": "[parameters('environment')]",
                "tier": "backend"
            },
            "dependsOn": [
                "[concat('Microsoft.Resources/deployments/','VirtualNetworkExternalDeployment')]",
                "[resourceId('microsoft.insights/components/', parameters('AppInsightName'))]"
            ],
            "properties": {
                "name": "[parameters('AppName')]",
                "serverFarmId": "[parameters('serverFarmID')]",
                "hostingEnvironment": "[parameters('hostingEnvironment')]",
                "siteConfig": {
                    "connectionStrings": [
                        {
                            "name": "defaultConnection",
                            "ConnectionString": "[concat('Data Source=tcp:' , variables('SQLServerURL') , ',1433;Initial Catalog=',parameters('SQLDataBaseName'),';User Id=null@',variables('SQLServerURL'),';Password=',parameters('SQLAdminLoginPassword'),';')]",                        
                            "type": "SQLAzure"
                        }
                    ]
                }
            },
            "resources": [
                {
                    "apiVersion": "2015-08-01",
                    "name": "appsettings",
                    "type": "config",
                    "dependsOn": [
                        "[resourceId('Microsoft.Web/Sites', parameters('AppName'))]"
                    ],
                    "properties": {
                        "mode": "Incremental",
                        "APPINSIGHTS_INSTRUMENTATIONKEY": "[reference(concat('microsoft.insights/components/', parameters('AppInsightName'))).InstrumentationKey]"
                    }
                }
            ]
        }
    ]
}