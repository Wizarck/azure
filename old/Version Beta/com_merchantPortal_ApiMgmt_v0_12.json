{
    "$schema": "http://schema.management.azure.com/schemas/2014-04-01-preview/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "complianceProfile": {
            "type": "string",
            "allowedValues": [
				"no-pci",
                "pci"
            ],
            "defaultValue": "no-pci",
            "metadata": {
                "description": "PCI or no-PCI"
            }
        },
        "environment": {
            "type": "string",
            "allowedValues": [
				"production",
                "preproduction",
                "development"
            ],
            "defaultValue": "development",
            "metadata": {
                "description": "Define environment to deploy in"
            }
        },
        "NameForAPIManager": {
            "type": "string",
            "defaultValue": "commpamtew",
            "metadata": {
                "description": "API Manager name"
            }            
        },
        "apiManagerSKU": {
            "type": "string",
            "allowedValues": [
                "Developer",
                "Standard",
                "Premium"
            ],
            "defaultValue": "Developer",
            "metadata": {
                "description": "Define SKU of API Manager"
            }           
        },
        "administratorEmailForAPIManager": {
            "type": "string",
            "defaultValue": "testemail@hotmail.com",
            "metadata": {
                "description": "Email for emails and alerts"
            }            
        },
        "organizationNameForAPIManager": {
            "type": "string",
            "defaultValue": "TestOrg",
            "metadata": {
                "description": "Organization Name for emails and alerts"
            }            
        },
        "virtualNetworkName": {
            "type": "string",
            "defaultValue": "commp-vnet",
            "metadata": {
                "description": "Name of the existing Virtual Network (VNET) of Merchant Portal"
            }           
        },  
        "virtualNetworkResourceGroup": {
            "type": "string",
            "metadata": {
                "description": "Resource Group of Virtual Network Security Hub"
            }
        },
        "subnetAPIManagerName": {
            "type": "string",
            "defaultValue": "commptew",
            "metadata": {
                "description": "Name for API Manager Subnet"
            }
        },
        "subnetAPIManagerAddressPrefix": {
            "type": "string",
            "defaultValue": "10.25.25.0/27",
            "metadata": {
                "description": "CIDR block for API Manager Subnet"
            }
        },
        "NameForNSGOfAPIManager": {
            "type": "string",
            "defaultValue": "commp-apiManager-nsg",
            "metadata": {
                "description": "Network Security Group Name for API Manager Subnet"
            }
        },
        "proxyCustomHostname": {
            "type": "string",
            "metadata": {
                "description": "Proxy Custom hostname"
            }
        },
        "proxyCustomHostnameBase64EncodedPfxCertificate": {
            "type": "securestring",
            "metadata": {
                "description": "Base-64 encoded SSL .pfx Certificate for proxy custom hostname."
            }
        },
        "proxySSLCertificatePassword": {
            "type": "securestring",
            "metadata": {
                "description": "Proxy SSL certificate password"
            }
        },
        "portalCustomHostname": {
            "type": "string",
            "metadata": {
                "description": "Portal Custom hostname"
            }
        },
        "portalCustomHostnameBase64EncodedPfxCertificate": {
            "type": "securestring",
            "metadata": {
                "description": "Base-64 encoded SSL .pfx Certificate for portal custom hostname"
            }
        },
        "portalSSLCertificatePassword": {
            "type": "securestring",
            "metadata": {
                "description": "Portal SSL certificate password"
            }
        },
        "managementCustomHostname": {
            "type": "string",
            "metadata": {
                "description": "Management Custom hostname"
            }
        },
        "managementCustomHostnameBase64EncodedPfxCertificate": {
            "type": "securestring",
            "metadata": {
                "description": "Base-64 encoded SSL .pfx Certificate for management custom hostname"
            }
        },
        "managementSSLCertificatePassword": {
            "type": "securestring",
            "metadata": {
                "description": "Management SSL certificate password"
            }
        },
        "scmCustomHostname": {
            "type": "string",
            "metadata": {
                "description": "SCM Custom hostname"
            }
        },
        "scmCustomHostnameBase64EncodedPfxCertificate": {
            "type": "securestring",
            "metadata": {
                "description": "Base-64 encoded SSL .pfx Certificate for SCM custom hostname"
            }
        },
        "scmSSLCertificatePassword": {
            "type": "securestring",
            "metadata": {
                "description": "SCM SSL certificate password"
            }
        }        
    },
    "variables": {
        "subnetRef": "[resourceId(parameters('virtualNetworkResourceGroup'), 'Microsoft.Network/virtualNetworks/subnets', parameters('virtualNetworkName'), parameters('subnetAPIManagerName'))]"
    },
    "resources": [
        {
            "apiVersion": "2017-05-10",
            "name": "VirtualNetworkExternalDeployment",
            "type": "Microsoft.Resources/deployments",
            "resourceGroup": "[parameters('VirtualNetworkResourceGroup')]",
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {},
                    "variables": {},
                    "resources": [   
                        {           
                            "name": "[parameters('NameForNSGofAPIManager')]",
                            "type": "Microsoft.Network/networkSecurityGroups",
                            "apiVersion": "2015-05-01-preview",
                            "location": "[resourceGroup().location]",
                            "tags": {
                                "complianceProfile": "[parameters('complianceProfile')]",
                                "environment": "[parameters('environment')]",
                                "tier": "communications"
                            },
                            "properties": {
                                "securityRules": [
                                    {
                                        "name": "allow-managementWebServer",
                                        "properties": {
                                            "description": "Mgmt Web Server (TCP/3443)",
                                            "protocol": "TCP",
                                            "sourcePortRange": "*",
                                            "destinationPortRange": "3443",
                                            "sourceAddressPrefix": "INTERNET",
                                            "destinationAddressPrefix": "VirtualNetwork",
                                            "access": "Allow",
                                            "priority": 120,
                                            "direction": "Inbound"
                                        }
                                    },
                                    {
                                        "name": "allow-https-inbound",
                                        "properties": {
                                            "description": "HTTPS Azure Sync and Web (TCP/443)",
                                            "protocol": "TCP",
                                            "sourcePortRange": "*",
                                            "destinationPortRange": "443",
                                            "sourceAddressPrefix": "INTERNET",
                                            "destinationAddressPrefix": "VirtualNetwork",
                                            "access": "Allow",
                                            "priority": 300,
                                            "direction": "Inbound"
                                        }
                                    },
                                    {
                                        "name": "allow-http-inbound",
                                        "properties": {
                                            "description": "HTTPS API Mgmt(TCP/80)",
                                            "protocol": "TCP",
                                            "sourcePortRange": "*",
                                            "destinationPortRange": "80",
                                            "sourceAddressPrefix": "INTERNET",
                                            "destinationAddressPrefix": "VirtualNetwork",
                                            "access": "Allow",
                                            "priority": 320,
                                            "direction": "Inbound"
                                        }
                                    },
                                    {
                                        "name": "allow-redis-inbound",
                                        "properties": {
                                            "description": "Redis Cache Dependency (TCP/6381-6383)",
                                            "protocol": "TCP",
                                            "sourcePortRange": "*",
                                            "destinationPortRange": "6381-6383",
                                            "sourceAddressPrefix": "VirtualNetwork",
                                            "destinationAddressPrefix": "VirtualNetwork",
                                            "access": "Allow",
                                            "priority": 430,
                                            "direction": "Inbound"
                                        }
                                    },
                                    {
                                        "name": "allow-azureLoadBalancer",
                                        "properties": {
                                            "description": "Load Balancer Azure (TCP/*)",
                                            "protocol": "TCP",
                                            "sourcePortRange": "*",
                                            "destinationPortRange": "*",
                                            "sourceAddressPrefix": "AzureLoadBalancer",
                                            "destinationAddressPrefix": "VirtualNetwork",
                                            "access": "Allow",
                                            "priority": 510,
                                            "direction": "Inbound"
                                        }
                                    },
                                    {
                                        "name": "deny-all-inbound",
                                        "properties": {
                                            "description": "Deny all traffic",
                                            "protocol": "*",
                                            "sourcePortRange": "*",
                                            "destinationPortRange": "*",
                                            "sourceAddressPrefix": "*",
                                            "destinationAddressPrefix": "*",
                                            "access": "Deny",
                                            "priority": 1000,
                                            "direction": "Inbound"
                                        }
                                    },
                                    {
                                        "name": "allow-amqp",
                                        "properties": {
                                            "description": "Evenct center and Mgmt Agent Dependency (AMQP/5671)",
                                            "protocol": "TCP",
                                            "sourcePortRange": "*",
                                            "destinationPortRange": "5671",
                                            "sourceAddressPrefix": "VirtualNetwork",
                                            "destinationAddressPrefix": "INTERNET",
                                            "access": "Allow",
                                            "priority": 130,
                                            "direction": "Outbound"
                                        }
                                    },
                                    {
                                        "name": "allow-dns",
                                        "properties": {
                                            "description": "DNS (UDP/53)",
                                            "protocol": "UDP",
                                            "sourcePortRange": "*",
                                            "destinationPortRange": "53",
                                            "sourceAddressPrefix": "VirtualNetwork",
                                            "destinationAddressPrefix": "VirtualNetwork",
                                            "access": "Allow",
                                            "priority": 200,
                                            "direction": "Outbound"
                                        }
                                    },
                                    {
                                        "name": "allow-https-outbound",
                                        "properties": {
                                            "description": "HTTPS Azure Sync (TCP/443)",
                                            "protocol": "TCP",
                                            "sourcePortRange": "*",
                                            "destinationPortRange": "443",
                                            "sourceAddressPrefix": "VirtualNetwork",
                                            "destinationAddressPrefix": "INTERNET",
                                            "access": "Allow",
                                            "priority": 300,
                                            "direction": "Outbound"
                                        }
                                    },
                                    {
                                        "name": "allow-http-outbound",
                                        "properties": {
                                            "description": "HTTPS Azure Sync (TCP/80)",
                                            "protocol": "TCP",
                                            "sourcePortRange": "*",
                                            "destinationPortRange": "80",
                                            "sourceAddressPrefix": "VirtualNetwork",
                                            "destinationAddressPrefix": "INTERNET",
                                            "access": "Allow",
                                            "priority": 320,
                                            "direction": "Outbound"
                                        }
                                    },
                                    {
                                        "name": "allow-azureGit",
                                        "properties": {
                                            "description": "Azure GIT dependency (TCP/445)",
                                            "protocol": "TCP",
                                            "sourcePortRange": "*",
                                            "destinationPortRange": "445",
                                            "sourceAddressPrefix": "VirtualNetwork",
                                            "destinationAddressPrefix": "INTERNET",
                                            "access": "Allow",
                                            "priority": 340,
                                            "direction": "Outbound"
                                        }
                                    },                    
                                    {
                                        "name": "allow-azureSql",
                                        "properties": {
                                            "description": "Azure SQL Dependency (TCP/1433)",
                                            "protocol": "TCP",
                                            "sourcePortRange": "*",
                                            "destinationPortRange": "1433",
                                            "sourceAddressPrefix": "VirtualNetwork",
                                            "destinationAddressPrefix": "INTERNET",
                                            "access": "Allow",
                                            "priority": 400,
                                            "direction": "Outbound"
                                        }
                                    },
                                    {
                                        "name": "allow-azureSqlDynamicPort",
                                        "properties": {
                                            "description": "Azure SQL Dependency v12 (TCP/10000-11999)",
                                            "protocol": "TCP",
                                            "sourcePortRange": "*",
                                            "destinationPortRange": "10000-11999",
                                            "sourceAddressPrefix": "VirtualNetwork",
                                            "destinationAddressPrefix": "INTERNET",
                                            "access": "Allow",
                                            "priority": 410,
                                            "direction": "Outbound"
                                        }
                                    },
                                    {
                                        "name": "allow-azureSqlDynamicPort2",
                                        "properties": {
                                            "description": "Azure SQL Dependency v12 (TCP/14000-14999)",
                                            "protocol": "TCP",
                                            "sourcePortRange": "*",
                                            "destinationPortRange": "14000-14999",
                                            "sourceAddressPrefix": "VirtualNetwork",
                                            "destinationAddressPrefix": "INTERNET",
                                            "access": "Allow",
                                            "priority": 420,
                                            "direction": "Outbound"
                                        }
                                    },                    
                                    {
                                        "name": "allow-redis-outbound",
                                        "properties": {
                                            "description": "Redis Cache Dependency (TCP/6381-6383)",
                                            "protocol": "TCP",
                                            "sourcePortRange": "*",
                                            "destinationPortRange": "6381-6383",
                                            "sourceAddressPrefix": "VirtualNetwork",
                                            "destinationAddressPrefix": "VirtualNetwork",
                                            "access": "Allow",
                                            "priority": 430,
                                            "direction": "Outbound"
                                        }
                                    },                    
                                    {
                                        "name": "deny-all-outbound",
                                        "properties": {
                                            "description": "Deny all traffic",
                                            "protocol": "*",
                                            "sourcePortRange": "*",
                                            "destinationPortRange": "*",
                                            "sourceAddressPrefix": "*",
                                            "destinationAddressPrefix": "*",
                                            "access": "Deny",
                                            "priority": 1000,
                                            "direction": "Outbound"
                                        }
                                    }
                                ]
                            }
                        },                        
                        {     
                            "name": "[concat(parameters('virtualNetworkName'), '/', parameters('subnetAPIManagerName'))]",
                            "type": "Microsoft.Network/virtualNetworks/subnets",
                            "apiVersion": "2015-06-15",
                            "location": "[resourceGroup().location]",
                            "dependsOn": [
                                "[resourceId(parameters('virtualNetworkResourceGroup'),'Microsoft.Network/networkSecurityGroups', parameters('NameForNSGofAPIManager'))]"
                            ],
                            "tags": {
                                "complianceProfile": "[parameters('complianceProfile')]",
                                "environment": "[parameters('environment')]",
                                "tier": "communications"
                            },
                            "properties": {
                                "addressPrefix": "[parameters('subnetAPIManagerAddressPrefix')]",
                                "networkSecurityGroup": {
                                    "id": "[resourceId(parameters('virtualNetworkResourceGroup'),'Microsoft.Network/networkSecurityGroups', parameters('NameForNSGofAPIManager'))]"
                                }
                            }
                        }
                    ]
                },
                "parameters": {}
            }
        },   
        {
            "name": "[parameters('NameForAPIManager')]",
            "type": "Microsoft.ApiManagement/service",
            "apiVersion": "2016-10-10",
            "location": "[resourceGroup().location]",
            "dependsOn": [
                "[concat('Microsoft.Resources/deployments/','VirtualNetworkExternalDeployment')]"
            ],
            "sku": {
                "name": "[parameters('apiManagerSKU')]",
                "capacity": 1
            },
            "tags": {
                "complianceProfile": "[parameters('complianceProfile')]",
                "environment": "[parameters('environment')]",
                "tier": "integration"
            },        
            "properties": {
                "hostnameConfigurations": [
                    {
                        "type": "Proxy",
                        "hostName": "[parameters('proxyCustomHostname')]",
                        "encodedCertificate": "[parameters('proxyCustomHostnameBase64EncodedPfxCertificate')]",
                        "certificatePassword": "[parameters('proxySSLCertificatePassword')]",
                        "negotiateClientCertificate": false
                    },
                    {
                        "type": "Portal",
                        "hostName": "[parameters('portalCustomHostname')]",
                        "encodedCertificate": "[parameters('portalCustomHostnameBase64EncodedPfxCertificate')]",
                        "certificatePassword": "[parameters('portalSSLCertificatePassword')]",
                        "negotiateClientCertificate": false
                    },
                    {
                        "type": "Management",
                        "hostName": "[parameters('managementCustomHostname')]",
                        "encodedCertificate": "[parameters('managementCustomHostnameBase64EncodedPfxCertificate')]",
                        "certificatePassword": "[parameters('managementSSLCertificatePassword')]",
                        "negotiateClientCertificate": false
                    },
                    {
                        "type": "SCM",
                        "hostName": "[parameters('scmCustomHostname')]",
                        "encodedCertificate": "[parameters('scmCustomHostnameBase64EncodedPfxCertificate')]",
                        "certificatePassword": "[parameters('scmSSLCertificatePassword')]",
                        "negotiateClientCertificate": false
                    }
                ],
                "publisherEmail": "[parameters('AdministratorEmailForAPIManager')]",
                "publisherName": "[parameters('OrganizationNameForAPIManager')]",
                "virtualNetworkType": "Internal",
                "VirtualNetworkConfiguration": {
                    "properties": {
                        "subnetResourceId": "[variables('subnetRef')]",
                        "location": "[resourceGroup().location]"
                    }
                }                
            }
        }
    ]
}